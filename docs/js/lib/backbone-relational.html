<!DOCTYPE html>  <html> <head>   <title>backbone-relational.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="backbone-min.html">                 backbone-min.js               </a>                                           <a class="source" href="backbone-relational.html">                 backbone-relational.js               </a>                                           <a class="source" href="jquery-1.7.2.html">                 jquery-1.7.2.js               </a>                                           <a class="source" href="json2.html">                 json2.js               </a>                                           <a class="source" href="underscore-min.html">                 underscore-min.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               backbone-relational.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Backbone-relational.js 0.5.0</span>
<span class="cm"> * (c) 2011 Paul Uithol</span>
<span class="cm"> * </span>
<span class="cm"> * Backbone-relational may be freely distributed under the MIT license.</span>
<span class="cm"> * For details and documentation: https://github.com/PaulUithol/Backbone-relational.</span>
<span class="cm"> * Depends on Backbone: https://github.com/documentcloud/backbone.</span>
<span class="cm"> */</span>
<span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
  <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
  
  <span class="cm">/**</span>
<span class="cm">   * CommonJS shim</span>
<span class="cm">   **/</span>
  <span class="kd">var</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">exports</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;underscore&#39;</span> <span class="p">);</span>
    <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;backbone&#39;</span> <span class="p">);</span>
    <span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">_</span><span class="p">;</span>
    <span class="nx">Backbone</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">;</span>
    <span class="nx">exports</span> <span class="o">=</span> <span class="nb">window</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">showWarnings</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * Semaphore mixin; can be used as both binary and counting.</span>
<span class="cm">   **/</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Semaphore</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">_permitsAvailable</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">_permitsUsed</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    
    <span class="nx">acquire</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_permitsAvailable</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_permitsUsed</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_permitsAvailable</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">&#39;Max permits acquired&#39;</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_permitsUsed</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">release</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_permitsUsed</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">&#39;All permits released&#39;</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_permitsUsed</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">isLocked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_permitsUsed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">setAvailablePermits</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">amount</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_permitsUsed</span> <span class="o">&gt;</span> <span class="nx">amount</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">&#39;Available permits cannot be less than used permits&#39;</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_permitsAvailable</span> <span class="o">=</span> <span class="nx">amount</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
  
  <span class="cm">/**</span>
<span class="cm">   * A BlockingQueue that accumulates items while blocked (via &#39;block&#39;),</span>
<span class="cm">   * and processes them when unblocked (via &#39;unblock&#39;).</span>
<span class="cm">   * Process can also be called manually (via &#39;process&#39;).</span>
<span class="cm">   */</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">BlockingQueue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">};</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">BlockingQueue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Semaphore</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">_queue</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    
    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">func</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isBlocked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">func</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">func</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">process</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()();</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">block</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="nx">unblock</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isBlocked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">process</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">isBlocked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="cm">/**</span>
<span class="cm">   * Global event queue. Accumulates external events (&#39;add:&lt;key&gt;&#39;, &#39;remove:&lt;key&gt;&#39; and &#39;update:&lt;key&gt;&#39;)</span>
<span class="cm">   * until the top-level object is fully initialized (see &#39;Backbone.RelationalModel&#39;).</span>
<span class="cm">   */</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">BlockingQueue</span><span class="p">();</span>
  
  <span class="cm">/**</span>
<span class="cm">   * Backbone.Store keeps track of all created (and destruction of) Backbone.RelationalModel.</span>
<span class="cm">   * Handles lookup for relations.</span>
<span class="cm">   */</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Store</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_collections</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_reverseRelations</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_subModels</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_modelScopes</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">exports</span> <span class="p">];</span>
  <span class="p">};</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Store</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">addModelScope</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">scope</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_modelScopes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">scope</span> <span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Add a set of subModelTypes to the store, that can be used to resolve the &#39;_superModel&#39;</span>
<span class="cm">     * for a model later in &#39;setupSuperModel&#39;.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Backbone.RelationalModel} subModelTypes</span>
<span class="cm">     * @param {Backbone.RelationalModel} superModelType</span>
<span class="cm">     */</span>
    <span class="nx">addSubModels</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">subModelTypes</span><span class="p">,</span> <span class="nx">superModelType</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_subModels</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="s1">&#39;superModelType&#39;</span><span class="o">:</span> <span class="nx">superModelType</span><span class="p">,</span>
        <span class="s1">&#39;subModels&#39;</span><span class="o">:</span> <span class="nx">subModelTypes</span>
      <span class="p">});</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Check if the given modelType is registered as another model&#39;s subModel. If so, add it to the super model&#39;s</span>
<span class="cm">     * &#39;_subModels&#39;, and set the modelType&#39;s &#39;_superModel&#39;, &#39;_subModelTypeName&#39;, and &#39;_subModelTypeAttribute&#39;.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Backbone.RelationalModel} modelType</span>
<span class="cm">     */</span>
    <span class="nx">setupSuperModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">modelType</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_subModels</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">subModelDef</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">subModelDef</span><span class="p">.</span><span class="nx">subModels</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">subModelTypeName</span><span class="p">,</span> <span class="nx">typeValue</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">subModelType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="nx">subModelTypeName</span> <span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">modelType</span> <span class="o">===</span> <span class="nx">subModelType</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Set 'modelType' as a child of the found superModel</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">subModelDef</span><span class="p">.</span><span class="nx">superModelType</span><span class="p">.</span><span class="nx">_subModels</span><span class="p">[</span> <span class="nx">typeValue</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">modelType</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set '<em>superModel', '</em>subModelTypeValue', and '_subModelTypeAttribute' on 'modelType'.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">modelType</span><span class="p">.</span><span class="nx">_superModel</span> <span class="o">=</span> <span class="nx">subModelDef</span><span class="p">.</span><span class="nx">superModelType</span><span class="p">;</span>
            <span class="nx">modelType</span><span class="p">.</span><span class="nx">_subModelTypeValue</span> <span class="o">=</span> <span class="nx">typeValue</span><span class="p">;</span>
            <span class="nx">modelType</span><span class="p">.</span><span class="nx">_subModelTypeAttribute</span> <span class="o">=</span> <span class="nx">subModelDef</span><span class="p">.</span><span class="nx">superModelType</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypeAttribute</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Add a reverse relation. Is added to the &#39;relations&#39; property on model&#39;s prototype, and to</span>
<span class="cm">     * existing instances of &#39;model&#39; in the store as well.</span>
<span class="cm">     * @param {Object} relation</span>
<span class="cm">     * @param {Backbone.RelationalModel} relation.model</span>
<span class="cm">     * @param {String} relation.type</span>
<span class="cm">     * @param {String} relation.key</span>
<span class="cm">     * @param {String|Object} relation.relatedModel</span>
<span class="cm">     */</span>
    <span class="nx">addReverseRelation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">exists</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reverseRelations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span> <span class="nx">relation</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">val</span> <span class="o">===</span> <span class="nx">rel</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
            <span class="p">});</span>
        <span class="p">});</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">exists</span> <span class="o">&amp;&amp;</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">model</span> <span class="o">&amp;&amp;</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_reverseRelations</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">);</span>
        
        <span class="kd">var</span> <span class="nx">addRelation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">}</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">);</span>
          
          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">_subModels</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">subModel</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">addRelation</span><span class="p">(</span> <span class="nx">subModel</span><span class="p">,</span> <span class="nx">relation</span> <span class="p">);</span>
            <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">};</span>
        
        <span class="nx">addRelation</span><span class="p">(</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="nx">relation</span> <span class="p">);</span>
        
        <span class="k">this</span><span class="p">.</span><span class="nx">retroFitRelation</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Add a &#39;relation&#39; to all existing instances of &#39;relation.model&#39; in the store</span>
<span class="cm">     * @param {Object} relation</span>
<span class="cm">     */</span>
    <span class="nx">retroFitRelation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">model</span> <span class="p">);</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">new</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">relation</span> <span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Find the Store&#39;s collection for a certain type of model.</span>
<span class="cm">     * @param {Backbone.RelationalModel} model</span>
<span class="cm">     * @return {Backbone.Collection} A collection if found (or applicable for &#39;model&#39;), or null</span>
<span class="cm">     */</span>
    <span class="nx">getCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">rootModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span> <span class="nx">rootModel</span><span class="p">.</span><span class="nx">_superModel</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">rootModel</span> <span class="o">=</span> <span class="nx">rootModel</span><span class="p">.</span><span class="nx">_superModel</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_collections</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">c</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">model</span> <span class="o">===</span> <span class="nx">rootModel</span><span class="p">;</span>
        <span class="p">});</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_createCollection</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">coll</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Find a type on the global object by name. Splits name on dots.</span>
<span class="cm">     * @param {String} name</span>
<span class="cm">     * @return {Object}</span>
<span class="cm">     */</span>
    <span class="nx">getObjectByName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">name</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="s1">&#39;.&#39;</span> <span class="p">),</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modelScopes</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">scope</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span> <span class="nx">parts</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">val</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">memo</span><span class="p">[</span> <span class="nx">val</span> <span class="p">];</span>
        <span class="p">},</span> <span class="nx">scope</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">!==</span> <span class="nx">scope</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>

      <span class="k">return</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">_createCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coll</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>If 'type' is an instance, take its constructor</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Type should inherit from Backbone.RelationalModel.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">coll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>
        <span class="nx">coll</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        
        <span class="k">this</span><span class="p">.</span><span class="nx">_collections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">coll</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">coll</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Find the attribute that is to be used as the `id` on a given object</span>
<span class="cm">     * @param type</span>
<span class="cm">     * @param {String|Number|Object|Backbone.RelationalModel} item</span>
<span class="cm">     */</span>
    <span class="nx">resolveIdForItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">item</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">id</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">id</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">id</span> <span class="o">=</span> <span class="nx">item</span><span class="p">[</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">idAttribute</span> <span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     * @param type</span>
<span class="cm">     * @param {String|Number|Object|Backbone.RelationalModel} item</span>
<span class="cm">     */</span>
    <span class="nx">find</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveIdForItem</span><span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">item</span> <span class="p">);</span>
      <span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">type</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Because the found object could be of any of the type's superModel
types, only return it if it's actually of the type asked for.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">coll</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Add a &#39;model&#39; to it&#39;s appropriate collection. Retain the original contents of &#39;model.collection&#39;.</span>
<span class="cm">     * @param {Backbone.RelationalModel} model</span>
<span class="cm">     */</span>
    <span class="nx">register</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">modelColl</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
      <span class="nx">coll</span> <span class="o">&amp;&amp;</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">unregister</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="nx">modelColl</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Explicitly update a model&#39;s id in it&#39;s store collection</span>
<span class="cm">     * @param {Backbone.RelationalModel} model</span>
<span class="cm">     */</span>
    <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">_onModelEvent</span><span class="p">(</span> <span class="s1">&#39;change:&#39;</span> <span class="o">+</span> <span class="nx">model</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Remove a &#39;model&#39; from the store.</span>
<span class="cm">     * @param {Backbone.RelationalModel} model</span>
<span class="cm">     */</span>
    <span class="nx">unregister</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">unregister</span> <span class="p">);</span>
      <span class="kd">var</span> <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
      <span class="nx">coll</span> <span class="o">&amp;&amp;</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Store</span><span class="p">();</span>
  
  <span class="cm">/**</span>
<span class="cm">   * The main Relation class, from which &#39;HasOne&#39; and &#39;HasMany&#39; inherit. Internally, &#39;relational:&lt;key&gt;&#39; events</span>
<span class="cm">   * are used to regulate addition and removal of models from relations.</span>
<span class="cm">   *</span>
<span class="cm">   * @param {Backbone.RelationalModel} instance</span>
<span class="cm">   * @param {Object} options</span>
<span class="cm">   * @param {string} options.key</span>
<span class="cm">   * @param {Backbone.RelationalModel.constructor} options.relatedModel</span>
<span class="cm">   * @param {Boolean|String} [options.includeInJSON=true] Serialize the given attribute for related model(s)&#39; in toJSON, or just their ids.</span>
<span class="cm">   * @param {Boolean} [options.createModels=true] Create objects from the contents of keys if the object is not found in Backbone.store.</span>
<span class="cm">   * @param {Object} [options.reverseRelation] Specify a bi-directional relation. If provided, Relation will reciprocate</span>
<span class="cm">   *    the relation to the &#39;relatedModel&#39;. Required and optional properties match &#39;options&#39;, except that it also needs</span>
<span class="cm">   *    {Backbone.Relation|String} type (&#39;HasOne&#39; or &#39;HasMany&#39;).</span>
<span class="cm">   */</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Make sure 'options' is sane, and fill with defaults from subclasses and this object's prototype</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">options</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">reverseRelation</span> <span class="o">||</span> <span class="p">{},</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">reverseRelation</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">type</span> <span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">type</span> <span class="o">:</span>
      <span class="nx">Backbone</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">type</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">type</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">model</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span> <span class="nx">options</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">options</span> <span class="p">);</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keySource</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keySource</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">keySource</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>'exports' should be the global object where 'relatedModel' can be found on if given as a string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">checkPreconditions</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keySource</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Explicitly clear 'keySource', to prevent a leaky abstraction if 'keySource' differs from 'key'.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">keySource</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keySource</span><span class="p">,</span> <span class="p">{</span> <span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Add this Relation to instance._relations</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Add the reverse relation on 'relatedModel' to the store's reverseRelations</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">isAutoRelation</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">addReverseRelation</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span> <span class="p">{</span>
          <span class="nx">isAutoRelation</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">,</span>
          <span class="nx">relatedModel</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
          <span class="nx">reverseRelation</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="c1">// current relation is the &#39;reverseRelation&#39; for it&#39;s own reverseRelation</span>
        <span class="p">},</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span> <span class="c1">// Take further properties from this.reverseRelation (type, key, etc.)</span>
      <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_modelRemovedFromCollection&#39;</span><span class="p">,</span> <span class="s1">&#39;_relatedModelAdded&#39;</span><span class="p">,</span> <span class="s1">&#39;_relatedModelRemoved&#39;</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>When a model in the store is destroyed, check if it is 'this.instance'.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modelRemovedFromCollection</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>When 'relatedModel' are created or destroyed, check if it affects this relation.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatedModelAdded</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatedModelRemoved</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Fix inheritance :\</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Set up all inheritable <strong>Backbone.Relation</strong> properties and methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Semaphore</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">createModels</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">includeInJSON</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">isAutoRelation</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    
    <span class="nx">instance</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">key</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">keyContents</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">relatedModel</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">reverseRelation</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">related</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    
    <span class="nx">_relatedModelAdded</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Allow 'model' to set up it's relations, before calling 'tryAddRelated'
(which can result in a call to 'addRelated' on a relation of 'model')</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">dit</span><span class="p">.</span><span class="nx">tryAddRelated</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    
    <span class="nx">_relatedModelRemoved</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">removeRelated</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">_modelRemovedFromCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Check several pre-conditions.</span>
<span class="cm">     * @return {Boolean} True if pre-conditions are satisfied, false if they&#39;re not.</span>
<span class="cm">     */</span>
    <span class="nx">checkPreconditions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
        <span class="nx">rm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">,</span>
        <span class="nx">warn</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">showWarnings</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">console</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">m</span> <span class="o">||</span> <span class="o">!</span><span class="nx">k</span> <span class="o">||</span> <span class="o">!</span><span class="nx">rm</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">warn</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;Relation=%o; no model, key or relatedModel (%o, %o, %o)&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">rm</span> <span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Check if the type in 'relatedModel' inherits from Backbone.RelationalModel</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">m</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">warn</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;Relation=%o; model does not inherit from Backbone.RelationalModel (%o)&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">i</span> <span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Check if the type in 'relatedModel' inherits from Backbone.RelationalModel</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">rm</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">warn</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">rm</span> <span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Check if this is not a HasMany, and the reverse relation is HasMany as well</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">warn</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.&#39;</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Check if we're not attempting to create a duplicate relationship</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="p">.</span><span class="nx">_relations</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">exists</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">_relations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">hasReverseRelation</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="o">&amp;&amp;</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="o">===</span> <span class="nx">rm</span> <span class="o">&amp;&amp;</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">k</span> <span class="o">&amp;&amp;</span>
              <span class="p">(</span> <span class="o">!</span><span class="nx">hasReverseRelation</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>
          <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">exists</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">warn</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists&#39;</span><span class="p">,</span>
            <span class="k">this</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">rm</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Set the related model(s) for this relation</span>
<span class="cm">     * @param {Backbone.Mode|Backbone.Collection} related</span>
<span class="cm">     * @param {Object} [options]</span>
<span class="cm">     */</span>
    <span class="nx">setRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">related</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">=</span> <span class="nx">related</span><span class="p">;</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">related</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span> <span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Determine if a relation (on a different RelationalModel) is the reverse</span>
<span class="cm">     * relation of the current one.</span>
<span class="cm">     * @param {Backbone.Relation} relation</span>
<span class="cm">     * @return {Boolean}</span>
<span class="cm">     */</span>
    <span class="nx">_isReverseRelation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">instance</span> <span class="k">instanceof</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">key</span> <span class="o">&amp;&amp;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">relation</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Get the reverse relations (pointing back to &#39;this.key&#39; on &#39;this.instance&#39;) for the currently related model(s).</span>
<span class="cm">     * @param {Backbone.RelationalModel} [model] Get the reverse relations for a specific model.</span>
<span class="cm">     *    If not specified, &#39;this.related&#39; is used.</span>
<span class="cm">     * @return {Backbone.Relation[]}</span>
<span class="cm">     */</span>
    <span class="nx">getReverseRelations</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">reverseRelations</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Iterate over 'model', 'this.related.models' (if this.related is a Backbone.Collection), or wrap 'this.related' in an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">model</span> <span class="p">]</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">models</span> <span class="o">||</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="p">]</span> <span class="p">);</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">models</span> <span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">related</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">related</span><span class="p">.</span><span class="nx">getRelations</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_isReverseRelation</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">reverseRelations</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">);</span>
              <span class="p">}</span>
            <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      
      <span class="k">return</span> <span class="nx">reverseRelations</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Rename options.silent to options.silentChange, so events propagate properly.</span>
<span class="cm">     * (for example in HasMany, from &#39;addRelated&#39;-&gt;&#39;handleAddition&#39;)</span>
<span class="cm">     * @param {Object} [options]</span>
<span class="cm">     * @return {Object}</span>
<span class="cm">     */</span>
    <span class="nx">sanitizeOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">?</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="o">:</span> <span class="p">{};</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">options</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Rename options.silentChange to options.silent, so events are silenced as intended in Backbone&#39;s</span>
<span class="cm">     * original functions.</span>
<span class="cm">     * @param {Object} [options]</span>
<span class="cm">     * @return {Object}</span>
<span class="cm">     */</span>
    <span class="nx">unsanitizeOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">?</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="o">:</span> <span class="p">{};</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">options</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Cleanup. Get reverse relation, call removeRelated on each.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;relational:remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modelRemovedFromCollection</span> <span class="p">);</span>
      
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;relational:add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatedModelAdded</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;relational:remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relatedModelRemoved</span> <span class="p">);</span>
      
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">relation</span><span class="p">.</span><span class="nx">removeRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasOne</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasMany&#39;</span> <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;onChange&#39;</span> <span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:change:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span> <span class="p">);</span>

      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findRelated</span><span class="p">(</span> <span class="p">{</span> <span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Notify new 'related' object of the new relation.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">relation</span><span class="p">.</span><span class="nx">addRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">findRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">(</span> <span class="nx">item</span><span class="p">,</span> <span class="p">{</span> <span class="nx">create</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">createModels</span> <span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">model</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * If the key is changed, notify old &amp; new reverse relations and initialize the new relation</span>
<span class="cm">     */</span>
    <span class="nx">onChange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Don't accept recursive calls to onChange (like onChange->findRelated->findOrCreate->initializeRelations->addRelated->onChange)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>'options._related' is set by 'addRelated'/'removeRelated'. If it is set, the change
is the result of a call from a relation. If it's not, the change is the result of 
a 'set' call on this.instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_related</span> <span class="p">);</span>
      <span class="kd">var</span> <span class="nx">oldRelated</span> <span class="o">=</span> <span class="nx">changed</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_related</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="nx">changed</span> <span class="p">)</span> <span class="p">{</span>  
        <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Set new 'related'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">attr</span> <span class="k">instanceof</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">attr</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">related</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findRelated</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="nx">related</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Notify old 'related' object of the terminated relation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">oldRelated</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">!==</span> <span class="nx">oldRelated</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(</span> <span class="nx">oldRelated</span> <span class="p">),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">relation</span><span class="p">.</span><span class="nx">removeRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
          <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Notify new 'related' object of the new relation. Note we do re-apply even if this.related is oldRelated;
that can be necessary for bi-directional relations if 'this.instance' was created after 'this.related'.
In that case, 'this.instance' will already know 'this.related', but the reverse might not exist yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">relation</span><span class="p">.</span><span class="nx">addRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Fire the 'update:<key>' event if 'related' was updated</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">!==</span> <span class="nx">oldRelated</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">dit</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;update:&#39;</span> <span class="o">+</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * If a new &#39;this.relatedModel&#39; appears in the &#39;store&#39;, try to match it to the last set &#39;keyContents&#39;</span>
<span class="cm">     */</span>
    <span class="nx">tryAddRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">resolveIdForItem</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">,</span> <span class="nx">item</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">addRelated</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">addRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">oldRelated</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="p">{</span> <span class="nx">_related</span><span class="o">:</span> <span class="nx">oldRelated</span> <span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">removeRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">oldRelated</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="p">{</span> <span class="nx">_related</span><span class="o">:</span> <span class="nx">oldRelated</span> <span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">HasMany</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">collectionType</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    
    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">reverseRelation</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;HasOne&#39;</span> <span class="p">},</span>
      <span class="nx">collectionType</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">,</span>
      <span class="nx">collectionKey</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">collectionOptions</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;onChange&#39;</span><span class="p">,</span> <span class="s1">&#39;handleAddition&#39;</span><span class="p">,</span> <span class="s1">&#39;handleRemoval&#39;</span><span class="p">,</span> <span class="s1">&#39;handleReset&#39;</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:change:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Handle a custom 'collectionType'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">collectionType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionType</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">collectionType</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">collectionType</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">collectionType</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">collectionType</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">&#39;collectionType must inherit from Backbone.Collection&#39;</span> <span class="p">);</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Handle cases where a model/relation is created with a collection passed straight into 'attributes'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_prepareCollection</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_prepareCollection</span><span class="p">()</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">findRelated</span><span class="p">(</span> <span class="p">{</span> <span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">_getCollectionOptions</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionOptions</span> <span class="p">)</span> <span class="o">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionOptions</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="p">)</span> <span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionOptions</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Bind events and setup collectionKeys for a collection that is to be used as the backing store for a HasMany.</span>
<span class="cm">     * If no &#39;collection&#39; is supplied, a new collection will be created of the specified &#39;collectionType&#39; option.</span>
<span class="cm">     * @param {Backbone.Collection} [collection]</span>
<span class="cm">     */</span>
    <span class="nx">_prepareCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">collection</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">related</span>
          <span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;relational:add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleAddition</span> <span class="p">)</span>
          <span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;relational:remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleRemoval</span> <span class="p">)</span>
          <span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;relational:reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleReset</span> <span class="p">)</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">collection</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span> <span class="nx">collection</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">collectionType</span><span class="p">(</span> <span class="p">[],</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getCollectionOptions</span><span class="p">()</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">collection</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionKey</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionKey</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">reverseRelation</span><span class="p">.</span><span class="nx">key</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionKey</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span> <span class="nx">collection</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">collection</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">showWarnings</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">console</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;Relation=%o; collectionKey=%s already exists on collection=%o&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">collectionKey</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">collection</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">collection</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleAddition</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleRemoval</span> <span class="p">)</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleReset</span> <span class="p">);</span>
      
      <span class="k">return</span> <span class="nx">collection</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">findRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">models</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span><span class="p">.</span><span class="nx">models</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Handle cases the an API/user supplies just an Object/id instead of an Array</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="o">:</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Try to find instances of the appropriate 'relatedModel' in the store</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="k">instanceof</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">model</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">(</span> <span class="nx">item</span><span class="p">,</span> <span class="p">{</span> <span class="nx">create</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">createModels</span> <span class="p">}</span> <span class="p">);</span>
              <span class="p">}</span>

              <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">models</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
              <span class="p">}</span>
            <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Add all found 'models' in on go, so 'add' will only be called once (and thus 'sort', etc.)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unsanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * If the key is changed, notify old &amp; new reverse relations and initialize the new relation</span>
<span class="cm">     */</span>
    <span class="nx">onChange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Notify old 'related' object of the terminated relation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">relation</span><span class="p">.</span><span class="nx">removeRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Replace 'this.related' by 'attr' if it is a Backbone.Collection</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">attr</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_prepareCollection</span><span class="p">(</span> <span class="nx">attr</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Otherwise, 'attr' should be an array of related object ids.
Re-use the current 'this.related' if it is a Backbone.Collection, and remove any current entries.
Otherwise, create a new collection.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">coll</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">;</span>
          <span class="nx">coll</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">coll</span><span class="p">.</span><span class="nx">models</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">coll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_prepareCollection</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setRelated</span><span class="p">(</span> <span class="nx">coll</span> <span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">findRelated</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Notify new 'related' object of the new relation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">relation</span><span class="p">.</span><span class="nx">addRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span> <span class="o">&amp;&amp;</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;update:&#39;</span> <span class="o">+</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    
    <span class="nx">tryAddRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Check if this new model was specified in 'this.keyContents'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">keyContents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">resolveIdForItem</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">,</span> <span class="nx">item</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">id</span> <span class="o">===</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
          <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * When a model is added to a &#39;HasMany&#39;, trigger &#39;add&#39; on &#39;this.instance&#39; and notify reverse relations.</span>
<span class="cm">     * (should be &#39;HasOne&#39;, must set &#39;this.instance&#39; as their related).</span>
<span class="cm">     */</span>
    <span class="nx">handleAddition</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>console.debug('handleAddition called; args=%o', arguments);
Make sure the model is in fact a valid model before continuing.
(it can be invalid as a result of failing validation in Backbone.Collection._prepareModel)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(</span> <span class="nx">model</span> <span class="p">),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">relation</span><span class="p">.</span><span class="nx">addRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Only trigger 'add' once the newly added model is initialized (so, has it's relations set up)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span> <span class="o">&amp;&amp;</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;add:&#39;</span> <span class="o">+</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * When a model is removed from a &#39;HasMany&#39;, trigger &#39;remove&#39; on &#39;this.instance&#39; and notify reverse relations.</span>
<span class="cm">     * (should be &#39;HasOne&#39;, which should be nullified)</span>
<span class="cm">     */</span>
    <span class="nx">handleRemoval</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">coll</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>console.debug('handleRemoval called; args=%o', arguments);</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getReverseRelations</span><span class="p">(</span> <span class="nx">model</span> <span class="p">),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">relation</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">relation</span><span class="p">.</span><span class="nx">removeRelated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span> <span class="o">&amp;&amp;</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;remove:&#39;</span> <span class="o">+</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">handleReset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">coll</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>

      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silentChange</span> <span class="o">&amp;&amp;</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;reset:&#39;</span> <span class="o">+</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    
    <span class="nx">addRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unsanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// Queued to avoid errors for adding &#39;model&#39; to the &#39;this.related&#39; set twice</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">dit</span><span class="p">.</span><span class="nx">related</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">dit</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>
    
    <span class="nx">removeRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unsanitizeOptions</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="cm">/**</span>
<span class="cm">   * A type of Backbone.Model that also maintains relations to other models and collections.</span>
<span class="cm">   * New events when compared to the original:</span>
<span class="cm">   *  - &#39;add:&lt;key&gt;&#39; (model, related collection, options)</span>
<span class="cm">   *  - &#39;remove:&lt;key&gt;&#39; (model, related collection, options)</span>
<span class="cm">   *  - &#39;update:&lt;key&gt;&#39; (model, related model or collection, options)</span>
<span class="cm">   */</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">relations</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// Relation descriptions on the prototype</span>
    <span class="nx">_relations</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// Relation instances</span>
    <span class="nx">_isInitialized</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">_deferProcessing</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">_queue</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    
    <span class="nx">subModelTypeAttribute</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span>
    <span class="nx">subModelTypes</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Nasty hack, for cases like 'model.get( <HasMany key> ).add( item )'.
Defer 'processQueue', so that when 'Relation.createModels' is used we:
a) Survive 'Backbone.Collection.add'; this takes care we won't error on "can't add model to a set twice"
   (by creating a model from properties, having the model add itself to the collection via one of
   it's relations, then trying to add it to the collection).
b) Trigger 'HasMany' collection events only after the model is really fully set up.
Example that triggers both a and b: "p.get('jobs').add( { company: c, person: p } )".</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_deferProcessing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        
        <span class="kd">var</span> <span class="nx">processQueue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="o">===</span> <span class="nx">dit</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">dit</span><span class="p">.</span><span class="nx">_deferProcessing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">dit</span><span class="p">.</span><span class="nx">processQueue</span><span class="p">();</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span> <span class="s1">&#39;relational:add&#39;</span><span class="p">,</span> <span class="nx">processQueue</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">};</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="s1">&#39;relational:add&#39;</span><span class="p">,</span> <span class="nx">processQueue</span> <span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>So we do process the queue eventually, regardless of whether this model really gets added to 'options.collection'.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">processQueue</span><span class="p">(</span> <span class="nx">dit</span> <span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">BlockingQueue</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Try to run the global queue holding external events</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Override &#39;trigger&#39; to queue &#39;change&#39; and &#39;change:*&#39; events</span>
<span class="cm">     */</span>
    <span class="nx">trigger</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;change&#39;</span> <span class="o">===</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">dit</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
          <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Initialize Relations present in this.relations; determine the type (HasOne/HasMany), then creates a new instance.</span>
<span class="cm">     * Invoked in the first call so &#39;set&#39; (which is made from the Backbone.Model constructor).</span>
<span class="cm">     */</span>
    <span class="nx">initializeRelations</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span> <span class="c1">// Setting up relations often also involve calls to &#39;set&#39;, and we only want to enter this function once</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_relations</span> <span class="o">=</span> <span class="p">[];</span>
      
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">relations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="o">:</span> <span class="nx">Backbone</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">new</span> <span class="nx">type</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">rel</span> <span class="p">);</span> <span class="c1">// Also pushes the new Relation into _relations</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">showWarnings</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">console</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span> <span class="s1">&#39;Relation=%o; missing or invalid type!&#39;</span><span class="p">,</span> <span class="nx">rel</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">_isInitialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">processQueue</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * When new values are set, notify this model&#39;s relations (also if options.silent is set).</span>
<span class="cm">     * (Relation.setRelated locks this model before calling &#39;set&#39; on it to prevent loops)</span>
<span class="cm">     */</span>
    <span class="nx">updateRelations</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_isInitialized</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Update from data in <code>rel.keySource</code> if set, or <code>rel.key</code> otherwise</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keySource</span> <span class="p">]</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">related</span> <span class="o">!==</span> <span class="nx">val</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;relational:change:&#39;</span> <span class="o">+</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{}</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Either add to the queue (if we&#39;re not initialized yet), or execute right away.</span>
<span class="cm">     */</span>
    <span class="nx">queue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">func</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">func</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Process _queue</span>
<span class="cm">     */</span>
    <span class="nx">processQueue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_isInitialized</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_deferProcessing</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">isBlocked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Get a specific relation.</span>
<span class="cm">     * @param key {string} The relation key to look for.</span>
<span class="cm">     * @return {Backbone.Relation} An instance of &#39;Backbone.Relation&#39;, if a relation was found for &#39;key&#39;, or null.</span>
<span class="cm">     */</span>
    <span class="nx">getRelation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Get all of the created relations.</span>
<span class="cm">     * @return {Backbone.Relation[]}</span>
<span class="cm">     */</span>
    <span class="nx">getRelations</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relations</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Retrieve related objects.</span>
<span class="cm">     * @param key {string} The relation key to fetch models for.</span>
<span class="cm">     * @param options {Object} Options for &#39;Backbone.Model.fetch&#39; and &#39;Backbone.sync&#39;.</span>
<span class="cm">     * @param update {boolean} Whether to force a fetch from the server (updating existing models).</span>
<span class="cm">     * @return {jQuery.when[]} An array of request objects</span>
<span class="cm">     */</span>
    <span class="nx">fetchRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">update</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="kd">var</span> <span class="nx">setUrl</span><span class="p">,</span>
        <span class="nx">requests</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">rel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRelation</span><span class="p">(</span> <span class="nx">key</span> <span class="p">),</span>
        <span class="nx">keyContents</span> <span class="o">=</span> <span class="nx">rel</span> <span class="o">&amp;&amp;</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyContents</span><span class="p">,</span>
        <span class="nx">toFetch</span> <span class="o">=</span> <span class="nx">keyContents</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">keyContents</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">keyContents</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">keyContents</span> <span class="p">],</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">resolveIdForItem</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">,</span> <span class="nx">item</span> <span class="p">);</span>
          <span class="k">return</span> <span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">update</span> <span class="o">||</span> <span class="o">!</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">,</span> <span class="nx">id</span> <span class="p">)</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="nx">toFetch</span> <span class="o">&amp;&amp;</span> <span class="nx">toFetch</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Create a model for each entry in 'keyContents' that is to be fetched</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">toFetch</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">model</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span> <span class="nx">item</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">model</span> <span class="o">=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span> <span class="nx">item</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="nx">attrs</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">idAttribute</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
            <span class="nx">model</span> <span class="o">=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span> <span class="nx">attrs</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="k">return</span> <span class="nx">model</span><span class="p">;</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
        </pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Try if the 'collection' can provide a url to fetch a set of models in one request.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">related</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">url</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">setUrl</span> <span class="o">=</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span> <span class="nx">models</span> <span class="p">);</span>
        <span class="p">}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>An assumption is that when 'Backbone.Collection.url' is a function, it can handle building of set urls.
To make sure it can, test if the url we got by supplying a list of models to fetch is different from
the one supplied for the default fetch action (without args to 'url').</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">setUrl</span> <span class="o">&amp;&amp;</span> <span class="nx">setUrl</span> <span class="o">!==</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span>
            <span class="p">{</span>
              <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
                    <span class="nx">options</span><span class="p">.</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
                  <span class="p">});</span>
              <span class="p">},</span>
              <span class="nx">url</span><span class="o">:</span> <span class="nx">setUrl</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="p">,</span>
            <span class="p">{</span> <span class="nx">add</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
          <span class="p">);</span>

          <span class="nx">requests</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">related</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span> <span class="nx">opts</span> <span class="p">)</span> <span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">requests</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span>
              <span class="p">{</span>
                <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
                  <span class="nx">options</span><span class="p">.</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
                <span class="p">}</span>
              <span class="p">},</span>
              <span class="nx">options</span>
            <span class="p">);</span>
            <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span> <span class="nx">opts</span> <span class="p">);</span>
          <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">requests</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Duplicate backbone's behavior to allow separate key/value parameters, instead of a single 'attributes' object</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">attributes</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">attributes</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Ideal place to set up relations :)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_isInitialized</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">initializeModelHierarchy</span><span class="p">();</span>

        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">initializeRelations</span><span class="p">();</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Update the 'idAttribute' in Backbone.store if; we don't want it to miss an 'id' update due to {silent:true}</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">idAttribute</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">updateRelations</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Try to run the global queue holding external events</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">unset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unset</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">updateRelations</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Try to run the global queue holding external events</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">updateRelations</span><span class="p">(</span> <span class="nx">options</span> <span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Try to run the global queue holding external events</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Override &#39;change&#39;, so the change will only execute after &#39;set&#39; has finised (relations are updated),</span>
<span class="cm">     * and &#39;previousAttributes&#39; will be available when the event is fired.</span>
<span class="cm">     */</span>
    <span class="nx">change</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">change</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">dit</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">idAttribute</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">attributes</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">idAttribute</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRelations</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">delete</span> <span class="nx">attributes</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="p">];</span>
        <span class="p">});</span>

      <span class="k">return</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">);</span>
    <span class="p">},</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Convert relations to JSON, omits them when required</span>
<span class="cm">     */</span>
    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>If this Model has already been fully serialized in this branch once, return to avoid loops</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">isLocked</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">acquire</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">_superModel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">_subModelTypeAttribute</span> <span class="k">in</span> <span class="nx">json</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">json</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">_subModelTypeAttribute</span> <span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">_subModelTypeValue</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="p">];</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeInJSON</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeInJSON</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeInJSON</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeInJSON</span> <span class="p">);</span>
            <span class="p">}</span> 
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeInJSON</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span> <span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">valueSub</span> <span class="o">=</span> <span class="p">[];</span>
              <span class="nx">value</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">curJson</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeInJSON</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">curJson</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">key</span> <span class="p">);</span>
                <span class="p">});</span>
                <span class="nx">valueSub</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">curJson</span> <span class="p">);</span>
              <span class="p">});</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">valueSub</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">valueSub</span> <span class="o">=</span> <span class="p">{};</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">includeInJSON</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">valueSub</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">key</span> <span class="p">);</span>
              <span class="p">});</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">valueSub</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="p">];</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">keyDestination</span> <span class="o">!==</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">json</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">key</span> <span class="p">];</span>
          <span class="p">}</span>
        <span class="p">});</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">superModel</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>We don't want to share a relations array with a parent, as this will cause problems with
reverse relations.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="o">=</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="o">||</span> <span class="p">[]</span> <span class="p">).</span><span class="nx">slice</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_subModels</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_superModel</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>If this model has 'subModelTypes' itself, remember them in the store</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span> <span class="s1">&#39;subModelTypes&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">addSubModels</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypes</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>The 'subModelTypes' property should not be inherited, so reset it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypes</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Initialize all reverseRelations that belong to this new model.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">rel</span><span class="p">.</span><span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">rel</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">reverseRelation</span> <span class="o">&amp;&amp;</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">model</span> <span class="o">===</span> <span class="k">this</span> <span class="p">)</span> <span class="p">{</span>        
            <span class="kd">var</span> <span class="nx">preInitialize</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
              <span class="cm">/**</span>
<span class="cm">               * The related model might not be defined for two reasons</span>
<span class="cm">               *  1. it never gets defined, e.g. a typo</span>
<span class="cm">               *  2. it is related to itself</span>
<span class="cm">               * In neither of these cases do we need to pre-initialize reverse relations.</span>
<span class="cm">               */</span>
              <span class="kd">var</span> <span class="nx">relatedModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">relatedModel</span> <span class="p">);</span>
              <span class="nx">preInitialize</span> <span class="o">=</span> <span class="nx">relatedModel</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">relatedModel</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span> <span class="p">);</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="o">:</span> <span class="nx">Backbone</span><span class="p">[</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">type</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">preInitialize</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relation</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">new</span> <span class="nx">type</span><span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">rel</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Create a &#39;Backbone.Model&#39; instance based on &#39;attributes&#39;.</span>
<span class="cm">     * @param {Object} attributes</span>
<span class="cm">     * @param {Object} [options]</span>
<span class="cm">     * @return {Backbone.Model}</span>
<span class="cm">     */</span>
    <span class="nx">build</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>'build' is a possible entrypoint; it's possible no model hierarchy has been determined yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">initializeModelHierarchy</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Determine what type of (sub)model should be built if applicable.
Lookup the proper subModelType in 'this._subModels'.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_subModels</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypeAttribute</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">subModelTypeAttribute</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypeAttribute</span> <span class="p">];</span>
        <span class="kd">var</span> <span class="nx">subModelType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_subModels</span><span class="p">[</span> <span class="nx">subModelTypeAttribute</span> <span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">subModelType</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">model</span> <span class="o">=</span> <span class="nx">subModelType</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="k">new</span> <span class="nx">model</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">initializeModelHierarchy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>If we're here for the first time, try to determine if this modelType has a 'superModel'.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_superModel</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNull</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_superModel</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">setupSuperModel</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>If a superModel has been found, copy relations from the <em>superModel if they haven't been
inherited automatically (due to a redefinition of 'relations').
Otherwise, make sure we don't get here again for this type by making '</em>superModel' false so we fail
the isUndefined/isNull check next time.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_superModel</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_superModel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">supermodelRelationsExist</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">rel</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">model</span> <span class="o">&amp;&amp;</span> <span class="nx">rel</span><span class="p">.</span><span class="nx">model</span> <span class="o">!==</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">supermodelRelationsExist</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_superModel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">relations</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_superModel</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>If we came here through 'build' for a model that has 'subModelTypes', and not all of them have been resolved yet, try to resolve each.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypes</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypes</span> <span class="p">).</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_subModels</span> <span class="p">).</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subModelTypes</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">subModelTypeName</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">subModelType</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getObjectByName</span><span class="p">(</span> <span class="nx">subModelTypeName</span> <span class="p">);</span>
          <span class="nx">subModelType</span> <span class="o">&amp;&amp;</span> <span class="nx">subModelType</span><span class="p">.</span><span class="nx">initializeModelHierarchy</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="cm">/**</span>
<span class="cm">     * Find an instance of `this` type in &#39;Backbone.Relational.store&#39;.</span>
<span class="cm">     * - If `attributes` is a string or a number, `findOrCreate` will just query the `store` and return a model if found.</span>
<span class="cm">     * - If `attributes` is an object, the model will be updated with `attributes` if found.</span>
<span class="cm">     *   Otherwise, a new model is created with `attributes` (unless `options.create` is explicitly set to `false`).</span>
<span class="cm">     * @param {Object|String|Number} attributes Either a model&#39;s id, or the attributes used to create or update a model.</span>
<span class="cm">     * @param {Object} [options]</span>
<span class="cm">     * @param {Boolean} [options.create=true]</span>
<span class="cm">     * @return {Backbone.RelationalModel}</span>
<span class="cm">     */</span>
    <span class="nx">findOrCreate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Try to find an instance of 'this' model type in the store</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>If we found an instance, update it with the data in 'item'; if not, create an instance
(unless 'options.create' is false).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span> <span class="nx">attributes</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">options</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">create</span> <span class="o">!==</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">model</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Semaphore</span> <span class="p">);</span>
  
  <span class="cm">/**</span>
<span class="cm">   * Override Backbone.Collection._prepareModel, so objects will be built using the correct type</span>
<span class="cm">   * if the collection.model has subModels.</span>
<span class="cm">   */</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__prepareModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_prepareModel</span><span class="p">;</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_prepareModel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">build</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">_validate</span><span class="p">(</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nx">model</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="cm">/**</span>
<span class="cm">   * Override Backbone.Collection.add, so objects fetched from the server multiple times will</span>
<span class="cm">   * update the existing Model. Also, trigger &#39;relational:add&#39;.</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">add</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__add</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span><span class="p">;</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">models</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">models</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">models</span> <span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">modelsToAdd</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>console.debug( 'calling add on coll=%o; model=%o, options=%o', this, models, options );</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Try to find 'model' in Backbone.store. If it already exists, set the new properties on it.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">existingModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="nx">model</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">idAttribute</span> <span class="p">]</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">existingModel</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">existingModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">existingModel</span><span class="p">.</span><span class="nx">parse</span> <span class="o">?</span> <span class="nx">existingModel</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
            <span class="nx">model</span> <span class="o">=</span> <span class="nx">existingModel</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_prepareModel</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">modelsToAdd</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Add 'models' in a single batch, so the original add will only be called once (and thus 'sort', etc).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="nx">modelsToAdd</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">add</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">modelsToAdd</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">modelsToAdd</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;relational:add&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="cm">/**</span>
<span class="cm">   * Override &#39;Backbone.Collection.remove&#39; to trigger &#39;relational:remove&#39;.</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">remove</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__remove</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span><span class="p">;</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">models</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">models</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">models</span> <span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">models</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>console.debug('calling remove on coll=%o; models=%o, options=%o', this, models, options );</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">remove</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;relational:remove&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span> <span class="p">);</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * Override &#39;Backbone.Collection.reset&#39; to trigger &#39;relational:reset&#39;.</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">reset</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__reset</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span><span class="p">;</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">reset</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;relational:reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * Override &#39;Backbone.Collection.sort&#39; to trigger &#39;relational:reset&#39;.</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">sort</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__sort</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sort</span><span class="p">;</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">sort</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">&#39;relational:reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span> <span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="cm">/**</span>
<span class="cm">   * Override &#39;Backbone.Collection.trigger&#39; so &#39;add&#39;, &#39;remove&#39; and &#39;reset&#39; events are queued until relations</span>
<span class="cm">   * are ready.</span>
<span class="cm">   */</span>
  <span class="kd">var</span> <span class="nx">trigger</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__trigger</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trigger</span><span class="p">;</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trigger</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">eventName</span> <span class="o">===</span> <span class="s1">&#39;add&#39;</span> <span class="o">||</span> <span class="nx">eventName</span> <span class="o">===</span> <span class="s1">&#39;remove&#39;</span> <span class="o">||</span> <span class="nx">eventName</span> <span class="o">===</span> <span class="s1">&#39;reset&#39;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dit</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Relational</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="nx">dit</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Override .extend() to automatically call .setup()</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">RelationalModel</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">protoProps</span><span class="p">,</span> <span class="nx">classProps</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>
    
    <span class="nx">child</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

    <span class="k">return</span> <span class="nx">child</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 